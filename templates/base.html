{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}GBP Automation Pro{% endblock %}</title>
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'css/output.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-100">
<div class="min-h-screen flex flex-col">

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden relative">
        <!-- Mobile Header -->
        <header class="bg-white shadow-sm md:hidden">
            <div class="px-4 py-3 flex justify-between items-center">
                <button id="mobile-menu-button" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="text-lg font-semibold text-gray-800">GBP Automation Pro</h1>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100">
            {% block content %}{% endblock %}
        </main>
    </div>
</div>

<!-- Mobile Sidebar -->
<div id="mobile-sidebar" class="fixed inset-0 z-40 hidden">
    <div class="absolute inset-0 bg-gray-600 opacity-75"></div>
    <div class="absolute inset-y-0 left-0 w-64 bg-white">
        {% block mobile_sidebar %}
            {{ block.super }}
        {% endblock %}
    </div>
</div>

{% block extra_body %}{% endblock %}

{% include 'components/feedback_button.html' %}
{% include 'components/compliance_modal.html' %}
{% include 'components/seo_health_modal.html' %}

<script>
    console.log('ðŸŒŸ Initializing base.html script');
    
    // Define toggleBusinessDetails in the global scope
    window.toggleBusinessDetails = function(businessId, event) {
        console.log('ðŸ”„ base.html: Toggle called for business:', businessId);
        
        if (event) {
            event.stopPropagation();
            console.log('ðŸ›‘ Event propagation stopped');
        }
        
        if (!businessId) {
            console.error('âŒ No business ID provided');
            return;
        }

        const row = document.querySelector(`[data-business-id="${businessId}"]`);
        console.log('ðŸ” Found business row:', row);
            
        if (!row) {
            console.error('âŒ Business row not found');
            return;
        }

        if (row.dataset.verified !== 'true') {
            console.log('âš ï¸ Business not verified');
            return;
        }

        const detailsRow = document.getElementById(`details-${businessId}`);
        const arrow = document.getElementById(`arrow-${businessId}`);
        const arrowSvg = arrow?.querySelector('svg');
            
        console.log('ðŸ“Š Details row:', detailsRow);
        console.log('âž¡ï¸ Arrow element:', arrow);
        console.log('ðŸŽ¯ Arrow SVG:', arrowSvg);

        if (!detailsRow) {
            console.error('âŒ Details row not found');
            return;
        }

        // Update business name in header if it exists
        const businessName = row.querySelector('.font-medium')?.textContent.trim();
        const businessNameHeader = document.getElementById('businessNameHeader');
        if (businessNameHeader && businessName) {
            businessNameHeader.textContent = businessName + "'s";
            console.log('âœï¸ Updated header with business name:', businessName);
        }

        // Close all other expanded rows first
        console.log('ðŸ”’ Closing other expanded rows...');
        document.querySelectorAll('.expanded-content').forEach(otherRow => {
            if (otherRow.id !== `details-${businessId}`) {
                console.log('ðŸ“ Closing row:', otherRow.id);
                otherRow.style.display = 'none';
                
                const otherId = otherRow.id.split('-')[1];
                const otherArrow = document.getElementById(`arrow-${otherId}`);
                if (otherArrow) {
                    const otherSvg = otherArrow.querySelector('svg');
                    otherArrow.style.transform = 'rotate(0deg)';
                    otherSvg.classList.remove('text-blue-500');
                    otherSvg.classList.add('text-gray-500');
                }
            }
        });

        // Toggle current row
        const isExpanding = detailsRow.style.display === 'none' || !detailsRow.style.display;
        console.log('ðŸ“ˆ Expanding row:', isExpanding);
        
        detailsRow.style.display = isExpanding ? 'table-row' : 'none';
        console.log('ðŸ”„ Set display to:', detailsRow.style.display);

        if (arrow && arrowSvg) {
            if (isExpanding) {
                console.log('â†—ï¸ Rotating arrow to expanded state');
                arrow.style.transform = 'rotate(90deg)';
                arrowSvg.classList.remove('text-gray-500');
                arrowSvg.classList.add('text-blue-500');
                
                // Update business summary and switch to details tab
                console.log('ðŸ“ Updating business summary');
                updateBusinessSummary(businessId);
                console.log('ðŸ”„ Switching to details tab');
                switchTab(businessId, 'details');
            } else {
                console.log('â†™ï¸ Rotating arrow to collapsed state');
                arrow.style.transform = 'rotate(0deg)';
                arrowSvg.classList.remove('text-blue-500');
                arrowSvg.classList.add('text-gray-500');
            }
        }

        // Prevent event bubbling
        if (event) {
            event.stopPropagation();
            console.log('ðŸ›‘ Event propagation stopped');
        }
        console.log('âœ… Toggle complete');
    };

    // Make sure the function is available after DOM loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ðŸŒŸ toggleBusinessDetails function initialized');
        if (typeof window.toggleBusinessDetails === 'function') {
            console.log('âœ… Function is properly defined in global scope');
        } else {
            console.error('âŒ Function not found in global scope');
        }
        
        // Call sortBusinessRows after DOM is fully loaded
        console.log('Calling sortBusinessRows from DOMContentLoaded');
        
        // Sort business rows
        function sortBusinessRows() {
            console.log('sortBusinessRows called');
            const tbody = document.querySelector('.business-table tbody');
            if (!tbody) {
                console.error("âŒ tbody element not found. Cannot sort business rows.");
                return;
            }
            const rows = Array.from(tbody.querySelectorAll('tr.expandable-row'));
            
            rows.sort((a, b) => {
                const aVerified = a.dataset.verified === 'true';
                const bVerified = b.dataset.verified === 'true';
                const aCompletion = parseInt(a.dataset.completion) || 0;
                const bCompletion = parseInt(b.dataset.completion) || 0;
                
                if (aVerified !== bVerified) return aVerified ? 1 : -1;
                return aCompletion - bCompletion;
            });
            
            rows.forEach(row => {
                tbody.appendChild(row);
                const detailsRow = document.getElementById(`details-${row.dataset.businessId}`);
                if (detailsRow) tbody.appendChild(detailsRow);
            });
        }
        
        sortBusinessRows();
    });

    // Automation settings functionality 
    function setAutomation(feature, level, businessId) {
        // Get all buttons for this feature and business
        const buttons = document.querySelectorAll(`[data-feature="${feature}"][data-business="${businessId}"]`);

        // Remove active class and background from all buttons for this feature
        buttons.forEach(btn => {
            btn.classList.remove('active');
            btn.classList.remove('bg-blue-500', 'bg-purple-500', 'bg-green-500');
            btn.classList.add('bg-white');
        });

        // Add active class and background to clicked button
        const clickedButton = document.querySelector(`[data-feature="${feature}"][data-position="${level}"][data-business="${businessId}"]`);
        if (clickedButton) {
            clickedButton.classList.add('active');

            // Add color based on feature
            switch (feature) {
                case 'qa':
                    clickedButton.classList.add('bg-blue-500');
                    break;
                case 'posts':
                    clickedButton.classList.add('bg-purple-500');
                    break;
                case 'reviews':
                    clickedButton.classList.add('bg-green-500');
                    break;
            }

            // Save to database via API
            fetch(`/api/business/${businessId}/automation/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    feature: feature,
                    level: level
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log(`Successfully updated ${feature} automation to ${level}`);
                    } else {
                        console.error('Failed to update automation settings');
                        revertButtonState(buttons, clickedButton);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    revertButtonState(buttons, clickedButton);
                });
        }
    }

    function revertButtonState(buttons, activeButton) {
        buttons.forEach(btn => {
            btn.classList.remove('active', 'bg-blue-500', 'bg-purple-500', 'bg-green-500');
            btn.classList.add('bg-white');
        });
        if (activeButton.classList.contains('active')) {
            activeButton.classList.remove('active');
        }
    }


    // Automation settings functionality
    function setAutomation(feature, level, businessId) {
        // Get all buttons for this feature and business
        const buttons = document.querySelectorAll(`[data-feature="${feature}"][data-business="${businessId}"]`);

        // Remove active class and background from all buttons for this feature
        buttons.forEach(btn => {
            btn.classList.remove('active');
            btn.classList.remove('bg-blue-500', 'bg-purple-500', 'bg-green-500');
            btn.classList.add('bg-white');
        });

        // Add active class and background to clicked button
        const clickedButton = document.querySelector(`[data-feature="${feature}"][data-position="${level}"][data-business="${businessId}"]`);
        if (clickedButton) {
            clickedButton.classList.add('active');

            // Add color based on feature
            switch (feature) {
                case 'qa':
                    clickedButton.classList.add('bg-blue-500');
                    break;
                case 'posts':
                    clickedButton.classList.add('bg-purple-500');
                    break;
                case 'reviews':
                    clickedButton.classList.add('bg-green-500');
                    break;
            }

            // Save to database via API
            fetch(`/api/business/${businessId}/automation/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    feature: feature,
                    level: level
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log(`Successfully updated ${feature} automation to ${level}`);
                    } else {
                        console.error('Failed to update automation settings');
                        revertButtonState(buttons, clickedButton);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    revertButtonState(buttons, clickedButton);
                });
        }
    }

    // Theme toggle functionality with system preference detection
    function initTheme() {
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;
        const sunIcon = themeToggle?.querySelector('.sun');
        const moonIcon = themeToggle?.querySelector('.moon');

        // Check for saved theme preference or default to light
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            html.classList.add('dark');
            if (sunIcon && moonIcon) {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        } else {
            html.classList.remove('dark');
            if (sunIcon && moonIcon) {
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            }
        }

        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                if (html.classList.contains('dark')) {
                    html.classList.remove('dark');
                    localStorage.theme = 'light';
                    if (moonIcon && sunIcon) {
                        moonIcon.classList.remove('hidden');
                        sunIcon.classList.add('hidden');
                    }
                } else {
                    html.classList.add('dark');
                    localStorage.theme = 'dark';
                    if (sunIcon && moonIcon) {
                        sunIcon.classList.remove('hidden');
                        moonIcon.classList.add('hidden');
                    }
                }
            });
        }
    }

    // Initialize theme on page load
    document.addEventListener('DOMContentLoaded', initTheme);

    // Business details toggle functionality
    function toggleBusinessDetails(businessId) {
        if (!businessId) return;
        
        const row = document.querySelector(`[data-business-id="${businessId}"]`);
        const detailsRow = document.getElementById(`details-${businessId}`);
        const arrow = document.getElementById(`arrow-${businessId}`);
        const arrowSvg = arrow?.querySelector('svg');

        if (!row || !detailsRow) return;

        if (row.dataset.verified !== 'Verified') {
            return; // Don't allow expansion for unverified businesses
        }

        // Update business name in header if it exists
        const businessName = row.querySelector('.font-medium').textContent.trim();
        const businessNameHeader = document.getElementById('businessNameHeader');
        if (businessNameHeader) {
            businessNameHeader.textContent = businessName + "'s";
        }

        // Close all other expanded rows
        document.querySelectorAll('[id^="details-"]').forEach(otherRow => {
            if (otherRow.id !== `details-${businessId}`) {
                otherRow.style.display = 'none';
                const otherArrow = document.getElementById(`arrow-${otherRow.id.split('-')[1]}`);
                if (otherArrow) {
                    const otherSvg = otherArrow.querySelector('svg');
                    otherArrow.style.transform = 'rotate(0deg)';
                    otherSvg.classList.remove('text-blue-500');
                    otherSvg.classList.add('text-gray-500');
                }
            }
        });

        // Toggle current row
        const isExpanding = detailsRow.style.display === 'none';
        detailsRow.style.display = isExpanding ? 'table-row' : 'none';

        // Update arrow
        if (arrow && arrowSvg) {
            if (isExpanding) {
                arrow.style.transform = 'rotate(90deg)';
                arrowSvg.classList.remove('text-gray-500');
                arrowSvg.classList.add('text-blue-500');
            } else {
                arrow.style.transform = 'rotate(0deg)';
                arrowSvg.classList.remove('text-blue-500');
                arrowSvg.classList.add('text-gray-500');
            }
        }

        // Update business summary if expanding
        if (isExpanding) {
            updateBusinessSummary(businessId);
            checkProfileStatus(businessId);
        }
    }

    function checkProfileStatus(businessId) {
        const row = document.querySelector(`[data-business-id="${businessId}"]`);
        if (!row) return;
        
        const completion = parseInt(row.dataset.completion) || 0;
        const verified = row.dataset.verified === 'Verified';
        
        // Update UI based on status
        if (!verified) {
            showAlertBanner('Your business profile requires verification. Click here to complete the process.', 'red');
        } else if (completion < 100) {
            showAlertBanner('Your business profile is missing important information. Click here to update.', 'orange');
        }
        
        }

        // Sort businesses by completion percentage and urgency
        function sortBusinessRows() {
        const tbody = document.querySelector('.business-table tbody');
        const rows = Array.from(tbody.querySelectorAll('tr.expandable-row'));

        rows.sort((a, b) => {
        const aVerified = a.dataset.verified === 'Verified';
        const bVerified = b.dataset.verified === 'Verified';
        const aCompletion = parseInt(a.dataset.completion) || 0;
        const bCompletion = parseInt(b.dataset.completion) || 0;

        // Unverified businesses come first
        if (aVerified !== bVerified) {
        return aVerified ? 1 : -1;
    }

        // Then sort by completion percentage (ascending)
        return aCompletion - bCompletion;
    });

        // Reorder the rows
        rows.forEach(row => {
        tbody.appendChild(row);
        const detailsRow = document.getElementById(`details-${row.dataset.businessId}`);
        if (detailsRow) {
        tbody.appendChild(detailsRow);
    }
    });
    }

        // Call sort on page load
        document.addEventListener('DOMContentLoaded', sortBusinessRows);

        // Mobile menu functionality
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileSidebar = document.getElementById('mobile-sidebar');

        if (mobileMenuButton && mobileSidebar) {
        mobileMenuButton.addEventListener('click', () => {
            mobileSidebar.classList.toggle('hidden');
        });

        mobileSidebar.addEventListener('click', (e) => {
        if (e.target === mobileSidebar) {
        mobileSidebar.classList.add('hidden');
    }
    });
    }
</script>
</body>
</html>
