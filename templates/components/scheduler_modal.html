<div id="schedulerModal" class="fixed inset-0 bg-black bg-opacity-50 z-[10000] backdrop-blur-sm overflow-y-auto hidden"
     onclick="handleModalClick(event)">
    <div class="min-h-full flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 relative" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium">Schedule New Automation</h3>
            <button onclick="closeSchedulerModal()" 
                    class="text-gray-500 hover:text-gray-700 text-2xl">
                &times;
            </button>
        </div>
        <form id="taskForm" data-business-id="">
            <input type="hidden" name="task_id" id="taskIdInput">
            <input type="hidden" name="business_id" id="businessIdInput">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Task Type</label>
                    <select name="task_type" class="w-full border rounded p-2" required>
                        <option value="POST">Social Post</option>
                        <option value="PHOTO">Photo Upload</option>
                        <option value="REVIEW">Review Monitoring</option>
                        <option value="QA">QA Check</option>
                        <option value="COMPLIANCE">Compliance Check</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Frequency</label>
                    <select name="frequency" class="w-full border rounded p-2" 
                            onchange="document.getElementById('customDate').style.display = this.value === 'custom' ? 'block' : 'none'">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div id="customDate" style="display: none;">
                    <label class="block text-sm font-medium mb-1">Date and Time</label>
                    <input type="datetime-local" name="custom_time" class="w-full border rounded p-2">
                </div>
                <button type="button" onclick="handleScheduleTask(this)" 
                        class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    <span id="submitButtonText">Schedule Task</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Edit/Delete functions moved to scheduler.html script
// Initialize scheduler modal early in load process
document.addEventListener('DOMContentLoaded', () => {
    window.showSchedulerModal = (businessId) => {
        console.log('[INFO] DOM Ready - Initializing scheduler modal');
        console.log('[INFO] showSchedulerModal called with businessId:', businessId);
        if (!businessId) {
            console.error('[ERROR] showSchedulerModal called without businessId');
            return;
        }
        
        const modal = document.getElementById('schedulerModal');
        console.log('[INFO] Found schedulerModal element:', modal);
        // Close any existing modals first
        document.querySelectorAll('.modal-open').forEach(m => m.classList.add('hidden'));
        
        console.log('[INFO] Setting business ID in modal:', businessId);
        document.getElementById('businessIdInput').value = businessId;
        document.getElementById('taskForm').dataset.businessId = businessId;
        console.log('[INFO] Showing modal for business:', businessId);
        // Remove all hiding classes and ensure proper display
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        // Bring modal to front with higher z-index
        modal.style.zIndex = '10000';
        // Ensure backdrop is visible
        modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
        // Force layout recalc to ensure visibility
        modal.getBoundingClientRect();
        console.log('[DEBUG] Modal computed styles:', window.getComputedStyle(modal));
    };

    // Close modal when clicking outside content
    function handleModalClick(event) {
        if (event.target === document.getElementById('schedulerModal')) {
            closeSchedulerModal();
        }
    }
    
    function closeSchedulerModal() {
        const modal = document.getElementById('schedulerModal');
        modal.classList.add('hidden');
        document.getElementById('taskIdInput').value = '';
        document.getElementById('existingTasks').classList.add('hidden');
        document.getElementById('submitButtonText').textContent = 'Schedule Task';
    }
    
    window.handleScheduleTask = (button) => {
        console.log('[INFO] handleScheduleTask called');
        const form = button.closest('form');
        const businessId = form.dataset.businessId;
        
        if (!businessId) {
            console.error('[ERROR] No businessId found in form');
            return;
        }
        
        const taskData = new FormData(form);
        const payload = {
            business_id: businessId,
            task_type: taskData.get('task_type'),
            frequency: taskData.get('frequency'),
            custom_time: taskData.get('custom_time'),
            csrfmiddlewaretoken: taskData.get('csrfmiddlewaretoken')
        };

        fetch(`/api/business/${businessId}/tasks/create/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': payload.csrfmiddlewaretoken
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showAlertBanner('Task scheduled successfully', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showAlertBanner(data.message || 'Error creating task', 'error');
            }
            closeSchedulerModal();
        })
        .catch(error => {
            console.error('Error:', error);
            showAlertBanner('Error creating task', 'error');
            closeSchedulerModal();
        });
    };
});
</script>
