<div id="schedulerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] backdrop-blur-sm flex items-center justify-center overflow-y-auto" 
     style="display: none;"
     onclick="handleModalClick(event)">
    <div class="bg-white rounded-lg p-6 max-w-md mx-4 relative" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium">Schedule New Automation</h3>
            <button onclick="closeSchedulerModal()" 
                    class="text-gray-500 hover:text-gray-700 text-2xl">
                &times;
            </button>
        </div>
        <form id="taskForm" data-business-id="">
            <input type="hidden" name="task_id" id="taskIdInput">
            <input type="hidden" name="business_id" id="businessIdInput">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Task Type</label>
                    <select name="task_type" class="w-full border rounded p-2" required>
                        <option value="POST">Social Post</option>
                        <option value="PHOTO">Photo Upload</option>
                        <option value="REVIEW">Review Monitoring</option>
                        <option value="QA">QA Check</option>
                        <option value="COMPLIANCE">Compliance Check</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Frequency</label>
                    <select name="frequency" class="w-full border rounded p-2" 
                            onchange="document.getElementById('customDate').style.display = this.value === 'custom' ? 'block' : 'none'">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div id="customDate" style="display: none;">
                    <label class="block text-sm font-medium mb-1">Date and Time</label>
                    <input type="datetime-local" name="custom_time" class="w-full border rounded p-2">
                </div>
                <button type="button" onclick="handleScheduleTask(this)" 
                        class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    <span id="submitButtonText">Schedule Task</span>
                </button>
                <div id="existingTasks" class="mt-4 border-t pt-4 hidden">
                    <h4 class="text-sm font-medium mb-2">Existing Schedules</h4>
                    <div id="taskList" class="space-y-2 max-h-40 overflow-y-auto"></div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// Initialize scheduler modal early in load process
document.addEventListener('DOMContentLoaded', () => {
    window.showSchedulerModal = (businessId) => {
        console.log('[INFO] DOM Ready - Initializing scheduler modal');
        console.log('[INFO] showSchedulerModal called with businessId:', businessId);
        if (!businessId) {
            console.error('[ERROR] showSchedulerModal called without businessId');
            return;
        }
        
        const modal = document.getElementById('schedulerModal');
        console.log('[INFO] Found schedulerModal element:', modal);
        // Close any existing modals first
        document.querySelectorAll('.modal-open').forEach(m => m.classList.add('hidden'));
        
        console.log('[INFO] Setting business ID in modal:', businessId);
        document.getElementById('businessIdInput').value = businessId;
        document.getElementById('taskForm').dataset.businessId = businessId;
        console.log('[INFO] Showing modal for business:', businessId);
        // Remove all hiding classes and ensure proper display
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        // Bring modal to front with higher z-index
        modal.style.zIndex = '10000';
        // Ensure backdrop is visible
        modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
        // Force layout recalc to ensure visibility
        modal.getBoundingClientRect();
        console.log('[DEBUG] Modal computed styles:', window.getComputedStyle(modal));
    };

    // Close modal when clicking outside content
    function handleModalClick(event) {
        if (event.target === document.getElementById('schedulerModal')) {
            closeSchedulerModal();
        }
    }
    
    function closeSchedulerModal() {
        const modal = document.getElementById('schedulerModal');
        modal.classList.add('hidden');
        modal.style.display = 'none';
        document.getElementById('taskIdInput').value = '';
        document.getElementById('existingTasks').classList.add('hidden');
        document.getElementById('submitButtonText').textContent = 'Schedule Task';
    }
    
    function loadExistingTasks(businessId) {
        fetch(`/api/business/${businessId}/tasks/`)
            .then(response => response.json())
            .then(tasks => {
                const taskList = document.getElementById('taskList');
                taskList.innerHTML = '';
                
                tasks.forEach(task => {
                    const taskEl = document.createElement('div');
                    taskEl.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
                    taskEl.innerHTML = `
                        <div>
                            <span class="text-sm">${task.task_type}</span>
                            <span class="text-xs text-gray-500 ml-2">${task.frequency}</span>
                        </div>
                        <div class="space-x-2">
                            <button onclick="editTask('${task.id}')" class="text-blue-500 hover:text-blue-700 text-sm">
                                Edit
                            </button>
                            <button onclick="deleteTask('${task.id}')" class="text-red-500 hover:text-red-700 text-sm">
                                Delete
                            </button>
                        </div>
                    `;
                    taskList.appendChild(taskEl);
                });
                
                if (tasks.length > 0) {
                    document.getElementById('existingTasks').classList.remove('hidden');
                }
            });
    }
    
    function editTask(taskId) {
        fetch(`/api/tasks/${taskId}/`)
            .then(response => response.json())
            .then(task => {
                document.getElementById('taskIdInput').value = task.id;
                document.getElementById('taskForm').querySelector('[name="task_type"]').value = task.task_type;
                document.getElementById('taskForm').querySelector('[name="frequency"]').value = task.frequency;
                if (task.custom_time) {
                    document.getElementById('customDate').style.display = 'block';
                    document.querySelector('[name="custom_time"]').value = task.custom_time;
                }
                document.getElementById('submitButtonText').textContent = 'Update Task';
            });
    }
    
    function deleteTask(taskId) {
        if (confirm('Are you sure you want to delete this schedule?')) {
            fetch(`/api/tasks/${taskId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            }).then(() => {
                loadExistingTasks(document.getElementById('businessIdInput').value);
                showAlertBanner('Schedule deleted successfully', 'success');
            });
        }
    }
    
    window.handleScheduleTask = (button) => {
        console.log('[INFO] handleScheduleTask called');
        const form = button.closest('form');
        const businessId = form.dataset.businessId;
        console.log('[INFO] Processing task for business:', businessId);
        
        if (!businessId) {
            console.error('[ERROR] No businessId found in form');
            return;
        }
        
        const taskData = new FormData(form);
        console.log('[INFO] Task data:', Object.fromEntries(taskData.entries()));
        
        // Add your task creation logic here
        console.log('Creating task for business:', businessId, taskData);
        
        // Close modal after submission
        const modal = document.getElementById('schedulerModal');
        modal.classList.add('hidden');
        modal.classList.remove('backdrop-blur-sm');
    };
});
</script>
