<div id="profileCompletionHeader" class="bg-white shadow-sm rounded-lg p-6 mb-8">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Complete <span id="businessNameHeader"></span> Profile</h2>
            <p class="text-gray-600">Follow these steps to unlock all features</p>
        </div>
        <div class="flex items-center">
            <div class="text-3xl font-bold text-blue-600" id="completionPercentage">
                {% with completion=business.calculate_profile_completion %}
                    {{ completion }}%
                {% endwith %}
            </div>
            <div class="ml-2 text-gray-500">Complete</div>
        </div>
    </div>

    <!-- Progress Steps -->
    <div class="relative">
        <!-- Progress Bar -->
        <div class="absolute top-1/2 left-0 w-full h-1 bg-gray-200 transform -translate-y-1/2"></div>
        <div class="absolute top-1/2 left-0 h-1 bg-blue-600 transform -translate-y-1/2 transition-all duration-500" 
             id="progressBar" style="width: 0%"></div>

        <!-- Steps -->
        <div class="relative flex justify-between">
            <!-- Step 1: Verification -->
            <div class="step-item" data-step="1">
                <div class="w-10 h-10 bg-white border-2 border-gray-300 rounded-full flex items-center justify-center relative z-10">
                    <i class="fas fa-check text-gray-400"></i>
                </div>
                <div class="mt-3 text-center">
                    <h3 class="font-medium text-gray-900">Get Verified</h3>
                    <p class="text-sm text-gray-500">Verify your business</p>
                </div>
            </div>

            <!-- Step 2: Basic Info -->
            <div class="step-item" data-step="2">
                <div class="w-10 h-10 bg-white border-2 border-gray-300 rounded-full flex items-center justify-center relative z-10">
                    <i class="fas fa-building text-gray-400"></i>
                </div>
                <div class="mt-3 text-center">
                    <h3 class="font-medium text-gray-900">Basic Info</h3>
                    <p class="text-sm text-gray-500">Add business details</p>
                </div>
            </div>

            <!-- Step 3: Photos -->
            <div class="step-item" data-step="3">
                <div class="w-10 h-10 bg-white border-2 border-gray-300 rounded-full flex items-center justify-center relative z-10">
                    <i class="fas fa-images text-gray-400"></i>
                </div>
                <div class="mt-3 text-center">
                    <h3 class="font-medium text-gray-900">Add Photos</h3>
                    <p class="text-sm text-gray-500">Upload business photos</p>
                </div>
            </div>

            <!-- Step 4: Hours -->
            <div class="step-item" data-step="4">
                <div class="w-10 h-10 bg-white border-2 border-gray-300 rounded-full flex items-center justify-center relative z-10">
                    <i class="fas fa-clock text-gray-400"></i>
                </div>
                <div class="mt-3 text-center">
                    <h3 class="font-medium text-gray-900">Business Hours</h3>
                    <p class="text-sm text-gray-500">Set your schedule</p>
                </div>
            </div>

            <!-- Step 5: Knowledge Base -->
            <div class="step-item" data-step="5">
                <div class="w-10 h-10 bg-white border-2 border-gray-300 rounded-full flex items-center justify-center relative z-10">
                    <i class="fas fa-brain text-gray-400"></i>
                </div>
                <div class="mt-3 text-center">
                    <h3 class="font-medium text-gray-900">Knowledge Base</h3>
                    <p class="text-sm text-gray-500">Upload business data</p>
                </div>
            </div>

            <!-- Step 6: Complete -->
            <div class="step-item" data-step="6">
                <div class="w-10 h-10 bg-white border-2 border-gray-300 rounded-full flex items-center justify-center relative z-10">
                    <i class="fas fa-flag-checkered text-gray-400"></i>
                </div>
                <div class="mt-3 text-center">
                    <h3 class="font-medium text-gray-900">All Set!</h3>
                    <p class="text-sm text-gray-500">Profile complete</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Step Details -->
    <div class="mt-8 p-6 bg-blue-50 rounded-lg" id="currentStepDetails">
        <div class="flex items-start space-x-4">
            <div class="flex-shrink-0">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-star text-blue-600 text-xl"></i>
                </div>
            </div>
            <div class="flex-grow">
                <h3 class="text-lg font-semibold text-gray-900" id="currentStepTitle">Get Verified</h3>
                <p class="text-gray-600 mt-1" id="currentStepDescription">
                    Verify your business to build trust with customers and unlock all features.
                </p>
                <div class="mt-4">
                    <button onclick="handleCurrentStep()" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors"
                            id="currentStepButton">
                        Start Verification
                    </button>
                </div>
            </div>
            <div class="flex-shrink-0">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                    Step <span id="currentStepNumber">1</span> of 5
                </span>
            </div>
        </div>
    </div>
</div>

<style>
.step-item.completed .w-10 {
    border-color: #2563eb;
    background-color: #2563eb;
}

.step-item.completed i {
    color: white;
}

.step-item.active .w-10 {
    border-color: #2563eb;
}

.step-item.active i {
    color: #2563eb;
}
</style>

<script>
let currentStep = 1;
const totalSteps = 6;
const stepData = {
    1: {
        title: "Get Verified",
        description: "Verify your business to build trust with customers and unlock all features.",
        buttonText: "Start Verification",
        icon: "star"
    },
    2: {
        title: "Add Basic Information",
        description: "Fill in your business details including address, phone, and category.",
        buttonText: "Update Details",
        icon: "building"
    },
    3: {
        title: "Upload Photos",
        description: "Add photos of your business to attract customers.",
        buttonText: "Upload Photos",
        icon: "images"
    },
    4: {
        title: "Set Business Hours",
        description: "Let customers know when you're open.",
        buttonText: "Set Hours",
        icon: "clock"
    },
    5: {
        title: "Build Your Knowledge Base",
        description: "Knowledge is power! Upload your business documents (PDFs, text files, directories) to help us provide more personalized and accurate responses. Simply drag and drop your files here.",
        buttonText: "Upload Files",
        icon: "brain"
    },
    6: {
        title: "Profile Complete!",
        description: "Congratulations! Your profile is now complete.",
        buttonText: "View Profile",
        icon: "flag-checkered"
    }
};

function updateProgress() {
    const percentage = ((currentStep - 1) / totalSteps) * 100;
    document.getElementById('completionPercentage').textContent = `${Math.round(percentage)}%`;
    document.getElementById('progressBar').style.width = `${percentage}%`;
    
    // Update step indicators
    document.querySelectorAll('.step-item').forEach((item, index) => {
        const stepNum = index + 1;
        if (stepNum < currentStep) {
            item.classList.add('completed');
            item.classList.remove('active');
        } else if (stepNum === currentStep) {
            item.classList.add('active');
            item.classList.remove('completed');
        } else {
            item.classList.remove('completed', 'active');
        }
    });

    // Update current step details
    const stepInfo = stepData[currentStep];
    document.getElementById('currentStepTitle').textContent = stepInfo.title;
    document.getElementById('currentStepDescription').textContent = stepInfo.description;
    document.getElementById('currentStepButton').textContent = stepInfo.buttonText;
    document.getElementById('currentStepNumber').textContent = currentStep;
}

function handleCurrentStep() {
    switch(currentStep) {
        case 1:
            window.open('https://www.google.com/business/', '_blank');
            // Start periodic status check
            startProfileStatusCheck();
            break;
        case 2:
            // Enable editing of business details
            toggleEditMode(document.querySelector('[data-business-id]').dataset.businessId);
            break;
        case 3:
            // Show photo upload modal
            // Implementation needed
            break;
        case 4:
            // Show hours setting modal
            // Implementation needed
            break;
        case 5:
            // Show completion celebration
            alert('Congratulations! Your profile is complete!');
            break;
    }
}

// Initialize progress and start status check
document.addEventListener('DOMContentLoaded', () => {
    updateProgress();
    startProfileStatusCheck();
});

function startProfileStatusCheck() {
    // Check status immediately
    checkProfileStatus();
    
    // Then check every 30 seconds
    const statusInterval = setInterval(checkProfileStatus, 30000);
    
    // Store interval ID in case we need to clear it later
    window.profileStatusInterval = statusInterval;
}

function checkProfileStatus(specificBusinessId = null) {
    // If specificBusinessId is provided, only check that business
    const businessRows = specificBusinessId ? 
        [document.querySelector(`[data-business-id="${specificBusinessId}"]`)] :
        document.querySelectorAll('[data-business-id]');
    
    businessRows.forEach(row => {
        if (!row) return;
        const businessId = row.dataset.businessId;
        // Skip dummy/unverified businesses
        if (businessId.startsWith('dummy-')) return;
        
        // Only check verification for real businesses
        fetch(`/api/business/${businessId}/verification-status/`)
        .then(response => {
            if (!response.ok) {
                if (response.status === 400) {
                    console.log('Skipping verification check for non-OAuth business');
                    return;
                }
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (!data) return;
            
            // Calculate completion percentage based on verified fields
            const totalFields = Object.keys(data).length;
            const completedFields = Object.values(data).filter(Boolean).length;
            const percentage = Math.round((completedFields / totalFields) * 100);
            
            // Update progress for this specific business
            const progressElement = row.querySelector('.completion-percentage');
            const progressBar = row.querySelector('.progress-bar-fill');
            if (progressElement) progressElement.textContent = `${percentage}%`;
            if (progressBar) progressBar.style.width = `${percentage}%`;
            
            // Update current step based on completion
            if (percentage === 100 && currentStep !== 5) {
                currentStep = 5;
                updateProgress();
            } else if (percentage >= 75 && currentStep < 4) {
                currentStep = 4;
                updateProgress();
            } else if (percentage >= 50 && currentStep < 3) {
                currentStep = 3;
                updateProgress();
            } else if (percentage >= 25 && currentStep < 2) {
                currentStep = 2;
                updateProgress();
            }
        })
        .catch(error => console.error('Error checking profile status:', error));
}
</script>
