<div class="bg-gradient-to-br from-blue-50 to-indigo-50 shadow-lg rounded-xl p-4 mb-6">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-xl font-bold text-gray-900">Business Profile Steps</h2>
            <p class="text-sm text-gray-600">Complete these steps to optimize your presence</p>
        </div>
    </div>

    <!-- Steps Timeline -->
    <div class="flex justify-between items-center mt-4">
        <div class="milestone-step" data-step="1">
            <div class="flex flex-col items-center">
                <div class="w-8 h-8 bg-white border-2 border-red-500 rounded-full flex items-center justify-center mb-1">
                    <i class="fas fa-check text-red-500"></i>
                </div>
                <span class="text-sm font-medium">Verification</span>
                <span id="step1-count" class="mt-1 text-xs font-semibold text-red-500">0</span>
            </div>
        </div>

        <div class="milestone-step" data-step="2">
            <div class="flex flex-col items-center">
                <div class="w-8 h-8 bg-white border-2 border-yellow-500 rounded-full flex items-center justify-center mb-1">
                    <i class="fas fa-building text-yellow-500"></i>
                </div>
                <span class="text-sm font-medium">Business Info</span>
                <span id="step2-count" class="mt-1 text-xs font-semibold text-yellow-500">0</span>
            </div>
        </div>

        <div class="milestone-step" data-step="3">
            <div class="flex flex-col items-center">
                <div class="w-8 h-8 bg-white border-2 border-green-500 rounded-full flex items-center justify-center mb-1">
                    <i class="fas fa-images text-green-500"></i>
                </div>
                <span class="text-sm font-medium">Media &amp; Hours</span>
                <span id="step3-count" class="mt-1 text-xs font-semibold text-green-500">0</span>
            </div>
        </div>

        <div class="milestone-step" data-step="4">
            <div class="flex flex-col items-center">
                <div class="w-8 h-8 bg-white border-2 border-blue-500 rounded-full flex items-center justify-center mb-1">
                    <i class="fas fa-flag-checkered text-blue-500"></i>
                </div>
                <span class="text-sm font-medium">Complete</span>
                <span id="step4-count" class="mt-1 text-xs font-semibold text-blue-500">0</span>
            </div>
        </div>
    </div>

    <!-- Action Button -->
    <div class="mt-4 text-center">
        <button onclick="handleCurrentStep()" 
                class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors text-sm font-medium"
                id="currentStepButton">
            Start Verification
        </button>
    </div>
</div>

<script>
let currentStep = 1;
const totalSteps = 6;
const stepData = {
    1: {
        title: "Get Verified",
        description: "Verify your business to build trust with customers and unlock all features.",
        buttonText: "Start Verification",
        icon: "star"
    },
    2: {
        title: "Complete Your Profile",
        description: "Add essential business details to help customers find you.",
        buttonText: "Update Details",
        icon: "building"
    },
    3: {
        title: "Add Photos",
        description: "Upload high-quality photos to showcase your business.",
        buttonText: "Upload Photos",
        icon: "images"
    },
    4: {
        title: "Set Business Hours",
        description: "Let customers know when you're open for business.",
        buttonText: "Set Hours",
        icon: "clock"
    },
    5: {
        title: "Build Knowledge Base",
        description: "Upload business documents to enhance our AI responses.",
        buttonText: "Upload Files",
        icon: "brain"
    },
    6: {
        title: "All Complete!",
        description: "Congratulations! Your business profile is fully optimized.",
        buttonText: "View Profile",
        icon: "flag-checkered"
    }
};

function updateProgress() {
    const percentage = ((currentStep - 1) / totalSteps) * 100;
    
    // Update progress indicators
    document.getElementById('overallProgress').textContent = `${Math.round(percentage)}%`;
    document.getElementById('progressBar').style.width = `${percentage}%`;
    document.getElementById('timelineProgress').style.width = `${percentage}%`;
    document.getElementById('achievementCount').textContent = `${currentStep - 1}/6`;
    
    // Update milestone steps
    document.querySelectorAll('.milestone-step').forEach((step, index) => {
        const stepNum = index + 1;
        const stepIcon = step.querySelector('.w-12');
        const stepIconContent = step.querySelector('i');
        
        if (stepNum < currentStep) {
            stepIcon.classList.remove('border-gray-300');
            stepIcon.classList.add('border-green-500', 'bg-green-500');
            stepIconContent.classList.remove('text-gray-400');
            stepIconContent.classList.add('text-white');
        } else if (stepNum === currentStep) {
            stepIcon.classList.remove('border-gray-300');
            stepIcon.classList.add('border-blue-500');
            stepIconContent.classList.remove('text-gray-400');
            stepIconContent.classList.add('text-blue-500');
        }
    });

    // Update current step details
    const stepInfo = stepData[currentStep];
    document.getElementById('currentStepTitle').textContent = stepInfo.title;
    document.getElementById('currentStepDescription').textContent = stepInfo.description;
    document.getElementById('currentStepButton').textContent = stepInfo.buttonText;
    document.getElementById('currentStepNumber').textContent = currentStep;
    document.getElementById('currentStepIcon').innerHTML = `<i class="fas fa-${stepInfo.icon} text-blue-600 text-xl"></i>`;
    
    // Update next step badge
    if (currentStep < totalSteps) {
        const nextStepInfo = stepData[currentStep + 1];
        document.getElementById('nextStepBadge').textContent = nextStepInfo.title.split(' ')[0];
        document.getElementById('nextStepDescription').textContent = nextStepInfo.description;
    }
}

function handleCurrentStep() {
    switch(currentStep) {
        case 1:
            window.open('https://www.google.com/business/', '_blank');
            break;
        case 2:
            toggleEditMode(document.querySelector('[data-business-id]').dataset.businessId);
            break;
        case 3:
            // Show photo upload modal
            break;
        case 4:
            // Show hours setting modal
            break;
        case 5:
            // Show file upload interface
            break;
        case 6:
            // Show completion celebration
            break;
    }
}

// Initialize progress
document.addEventListener('DOMContentLoaded', () => {
    updateProgress();
    startProfileStatusCheck();
    updateStepCounts();
});

function updateStepCounts() {
    const businesses = document.querySelectorAll('[data-business-id]');
    let stepCounts = [0, 0, 0, 0];
            
    businesses.forEach(business => {
        const completion = parseInt(business.dataset.completion) || 0;
        if (completion === 0) stepCounts[0]++;
        else if (completion <= 40) stepCounts[1]++;
        else if (completion <= 80) stepCounts[2]++;
        else stepCounts[3]++;
    });
            
    // Update count badges under each step
    for (let i = 1; i <= 4; i++) {
        const countSpan = document.getElementById(`step${i}-count`);
        if (countSpan) {
            countSpan.textContent = stepCounts[i-1];
            // Update color based on count
            if (stepCounts[i-1] > 0) {
                countSpan.classList.add('font-bold');
            } else {
                countSpan.classList.remove('font-bold');
            }
        }
    }
}

function highlightStep(step) {
    const businesses = document.querySelectorAll('[data-business-id]');
    businesses.forEach(business => {
        const completion = parseInt(business.dataset.completion) || 0;
        let isInStep = false;
                
        switch(step) {
            case 1: isInStep = completion === 0; break;
            case 2: isInStep = completion > 0 && completion <= 40; break;
            case 3: isInStep = completion > 40 && completion <= 80; break;
            case 4: isInStep = completion > 80; break;
        }
                
        if (isInStep) {
            business.classList.add('transform', 'translate-y-[-4px]', 'shadow-lg');
            business.style.transition = 'all 0.3s ease';
        }
    });
}

function unhighlightSteps() {
    const businesses = document.querySelectorAll('[data-business-id]');
    businesses.forEach(business => {
        business.classList.remove('transform', 'translate-y-[-4px]', 'shadow-lg');
    });
}

function updateStepCounts() {
    const businesses = document.querySelectorAll('[data-business-id]');
    let stepCounts = [0, 0, 0, 0];
            
    businesses.forEach(business => {
        const completion = parseInt(business.dataset.completion) || 0;
        if (completion === 0) stepCounts[0]++;
        else if (completion <= 40) stepCounts[1]++;
        else if (completion <= 80) stepCounts[2]++;
        else stepCounts[3]++;
    });
            
    // Update count badges
    for (let i = 1; i <= 4; i++) {
        document.getElementById(`step${i}-count`).textContent = stepCounts[i-1];
    }
}

function highlightStep(step) {
    const businesses = document.querySelectorAll('[data-business-id]');
    businesses.forEach(business => {
        const completion = parseInt(business.dataset.completion) || 0;
        let isInStep = false;
                
        switch(step) {
            case 1: isInStep = completion === 0; break;
            case 2: isInStep = completion > 0 && completion <= 40; break;
            case 3: isInStep = completion > 40 && completion <= 80; break;
            case 4: isInStep = completion > 80; break;
        }
                
        if (isInStep) {
            business.classList.add('transform', 'translate-y-[-4px]', 'shadow-lg');
            business.style.transition = 'all 0.3s ease';
        }
    });
}

function unhighlightSteps() {
    const businesses = document.querySelectorAll('[data-business-id]');
    businesses.forEach(business => {
        business.classList.remove('transform', 'translate-y-[-4px]', 'shadow-lg');
    });
}

function checkProfileStatus(businessId = null) {
    const businesses = businessId ? 
        [document.querySelector(`[data-business-id="${businessId}"]`)] :
        document.querySelectorAll('[data-business-id]');
    
    businesses.forEach(row => {
        if (!row) return;
        const businessId = row.dataset.businessId;
        if (businessId.startsWith('dummy-')) return;
        
        fetch(`/api/business/${businessId}/verification-status/`)
            .then(response => response.json())
            .then(data => {
                if (!data) return;
                
                const totalFields = Object.keys(data).length;
                const completedFields = Object.values(data).filter(Boolean).length;
                const percentage = Math.round((completedFields / totalFields) * 100);
                
                // Update progress for this specific business
                const progressElement = row.querySelector('.completion-percentage');
                const progressBar = row.querySelector('.progress-bar-fill');
                if (progressElement) progressElement.textContent = `${percentage}%`;
                if (progressBar) progressBar.style.width = `${percentage}%`;
                
                // Update current step based on completion
                if (percentage === 100 && currentStep !== 6) {
                    currentStep = 6;
                    updateProgress();
                } else if (percentage >= 80 && currentStep < 5) {
                    currentStep = 5;
                    updateProgress();
                } else if (percentage >= 60 && currentStep < 4) {
                    currentStep = 4;
                    updateProgress();
                } else if (percentage >= 40 && currentStep < 3) {
                    currentStep = 3;
                    updateProgress();
                } else if (percentage >= 20 && currentStep < 2) {
                    currentStep = 2;
                    updateProgress();
                }
            })
            .catch(error => console.error('Error checking profile status:', error));
    });
}
</script>
